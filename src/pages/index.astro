---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE, CATEGORIES, AUTHOR } from '../consts';
import { supabase } from '../lib/supabase';

// Fetch pending titles (not yet generated) - max 5
const { data: pendingTitles } = await supabase
	.from('article_titles')
	.select('*')
	.eq('is_generated', false)
	.order('created_at', { ascending: false })
	.limit(5);

// Fetch generated articles with their titles
const { data: generatedArticles } = await supabase
	.from('article_titles')
	.select(`
		*,
		articles (*)
	`)
	.eq('is_generated', true)
	.order('created_at', { ascending: false })
	.limit(20);

function getCategoryName(categoryId: string): string {
	const cat = CATEGORIES.find(c => c.id === categoryId);
	return cat?.name || categoryId;
}
---

<!doctype html>
<html lang="de">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body class="bg-[#f5f0e6] text-gray-800 text-lg leading-relaxed">
		<Header />

		<!-- Hero Section -->
		<section class="bg-gradient-to-br from-[#2d3e28] to-[#4a6741] text-[#f5f0e6] py-16 px-4 text-center">
			<div class="max-w-3xl mx-auto">
				<h1 class="text-4xl md:text-5xl font-bold mb-4 text-[#f5f0e6] drop-shadow-lg">
					{SITE_TITLE}
				</h1>
				<p class="text-xl md:text-2xl opacity-95 mb-6">
					{SITE_DESCRIPTION}
				</p>
				<p class="text-base opacity-80 border-t border-white/30 pt-4 mt-4">
					Von {AUTHOR.name} Â· {AUTHOR.experience}
				</p>
			</div>
		</section>

		<main class="max-w-4xl mx-auto px-4 py-8">
			{pendingTitles && pendingTitles.length > 0 && (
				<section class="mb-12">
					<div class="flex items-center border-b-2 border-[#2d3e28] pb-2 mb-4">
						<h2 class="text-2xl font-bold text-[#2d3e28]">Neue BeitrÃ¤ge</h2>
					</div>
					<p class="text-gray-600 mb-6">
						Diese Artikel werden beim ersten Aufruf frisch fÃ¼r Sie verfasst.
					</p>
					<div class="grid gap-6 md:grid-cols-2">
						{pendingTitles.map((title) => (
							<article class="bg-white rounded-lg shadow-md overflow-hidden transition-all duration-200 hover:-translate-y-1 hover:shadow-xl group">
								{title.image_url && (
									<a href={`/artikel/${title.id}`} class="block">
										<div class="relative h-48 overflow-hidden">
											<img
												src={title.image_url}
												alt={title.title}
												class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
											/>
											<span class="absolute top-3 right-3 bg-[#c9a54e] text-gray-800 px-2 py-0.5 rounded text-xs font-bold">
												NEU
											</span>
										</div>
									</a>
								)}
								<div class="p-5">
									<h3 class="text-xl font-semibold mb-2">
										<a href={`/artikel/${title.id}`} class="text-[#2d3e28] hover:text-[#4a6741] no-underline">
											{title.title}
										</a>
									</h3>
									<p class="text-gray-600 mb-3 text-base">{title.description}</p>
									<div class="text-sm">
										<span class="inline-block bg-[#2d3e28] text-[#f5f0e6] px-2.5 py-1 rounded">
											{getCategoryName(title.category)}
										</span>
									</div>
								</div>
							</article>
						))}
					</div>
				</section>
			)}

			{generatedArticles && generatedArticles.length > 0 && (
				<section class="mb-12">
					<div class="flex items-center border-b-2 border-[#2d3e28] pb-2 mb-4">
						<h2 class="text-2xl font-bold text-[#2d3e28]">Archiv</h2>
					</div>
					<div class="grid gap-6 md:grid-cols-2">
						{generatedArticles.map((item) => (
							<article class="bg-white rounded-lg shadow-md overflow-hidden transition-all duration-200 hover:-translate-y-1 hover:shadow-xl group">
								{item.image_url && (
									<a href={`/artikel/${item.id}`} class="block">
										<div class="relative h-48 overflow-hidden">
											<img
												src={item.image_url}
												alt={item.title}
												class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
											/>
										</div>
									</a>
								)}
								<div class="p-5">
									<h3 class="text-xl font-semibold mb-2">
										<a href={`/artikel/${item.id}`} class="text-[#2d3e28] hover:text-[#4a6741] no-underline">
											{item.title}
										</a>
									</h3>
									<p class="text-gray-600 mb-3 text-base">{item.description}</p>
									<div class="flex items-center gap-3 text-sm">
										<span class="inline-block bg-[#2d3e28] text-[#f5f0e6] px-2.5 py-1 rounded">
											{getCategoryName(item.category)}
										</span>
										{item.articles && item.articles[0] && (
											<span class="text-gray-500">
												{new Date(item.articles[0].generated_at).toLocaleDateString('de-DE', {
													year: 'numeric',
													month: 'long',
													day: 'numeric'
												})}
											</span>
										)}
									</div>
								</div>
							</article>
						))}
					</div>
				</section>
			)}

			{(!pendingTitles || pendingTitles.length === 0) && (!generatedArticles || generatedArticles.length === 0) && (
				<div class="text-center py-16 px-8 bg-white rounded-xl shadow-md">
					<div class="text-6xl mb-4">ðŸŒ²</div>
					<h2 class="text-2xl font-bold text-[#2d3e28] mb-3">
						Noch ist es still im Revier...
					</h2>
					<p class="text-gray-500 max-w-md mx-auto">
						Die ersten BeitrÃ¤ge werden bald erscheinen. Schauen Sie gerne wieder vorbei!
					</p>
				</div>
			)}
		</main>

		<Footer />
	</body>
</html>

---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import ArticleCard from '../components/ui/ArticleCard.astro';
import CategoryNav from '../components/ui/CategoryNav.astro';
import Pagination from '../components/ui/Pagination.astro';
import { SITE_DESCRIPTION, SITE_TITLE, AUTHOR } from '../consts';
import { supabase } from '../lib/supabase';

// Filter params
const yearFilter = Astro.url.searchParams.get('jahr');
const monthFilter = Astro.url.searchParams.get('monat');

// Pagination
const ARTICLES_PER_PAGE = 12;
const currentPage = Number(Astro.url.searchParams.get('page')) || 1;
const offset = (currentPage - 1) * ARTICLES_PER_PAGE;

// Get all generated article dates to build filter options
const { data: allDates } = await supabase
	.from('article_titles')
	.select('created_at')
	.eq('is_generated', true)
	.order('created_at', { ascending: false });

// Build year and month options from articles
const availableYears = new Set<number>();
const availableMonths = new Map<string, { year: number; month: number; label: string }>();

allDates?.forEach(article => {
	const date = new Date(article.created_at);
	const year = date.getFullYear();
	const month = date.getMonth() + 1;
	availableYears.add(year);
	const key = `${year}-${month}`;
	if (!availableMonths.has(key)) {
		const monthName = date.toLocaleDateString('de-DE', { month: 'long' });
		availableMonths.set(key, { year, month, label: `${monthName} ${year}` });
	}
});

const sortedYears = Array.from(availableYears).sort((a, b) => b - a);
const sortedMonths = Array.from(availableMonths.values()).sort((a, b) => {
	if (a.year !== b.year) return b.year - a.year;
	return b.month - a.month;
});

// Build filter conditions
let dateFilter: { start: string; end: string } | null = null;

if (yearFilter && monthFilter) {
	const year = parseInt(yearFilter);
	const month = parseInt(monthFilter);
	const start = new Date(year, month - 1, 1);
	const end = new Date(year, month, 0, 23, 59, 59);
	dateFilter = { start: start.toISOString(), end: end.toISOString() };
} else if (yearFilter) {
	const year = parseInt(yearFilter);
	const start = new Date(year, 0, 1);
	const end = new Date(year, 11, 31, 23, 59, 59);
	dateFilter = { start: start.toISOString(), end: end.toISOString() };
}

// Get total count with filters
let countQuery = supabase
	.from('article_titles')
	.select('*', { count: 'exact', head: true })
	.eq('is_generated', true);

if (dateFilter) {
	countQuery = countQuery.gte('created_at', dateFilter.start).lte('created_at', dateFilter.end);
}

const { count: totalCount } = await countQuery;
const totalPages = Math.ceil((totalCount || 0) / ARTICLES_PER_PAGE);

// Fetch articles for current page with filters
let articlesQuery = supabase
	.from('article_titles')
	.select(`
		*,
		articles (generated_at)
	`)
	.eq('is_generated', true)
	.order('created_at', { ascending: false });

if (dateFilter) {
	articlesQuery = articlesQuery.gte('created_at', dateFilter.start).lte('created_at', dateFilter.end);
}

const { data: articles } = await articlesQuery.range(offset, offset + ARTICLES_PER_PAGE - 1);

// Fetch pending titles for "Coming Soon" section
const { data: pendingTitles } = await supabase
	.from('article_titles')
	.select('*')
	.eq('is_generated', false)
	.order('created_at', { ascending: false })
	.limit(3);

// Build base URL for pagination
function buildBaseUrl(): string {
	const params = new URLSearchParams();
	if (yearFilter) params.set('jahr', yearFilter);
	if (monthFilter) params.set('monat', monthFilter);
	const queryString = params.toString();
	return queryString ? `/?${queryString}` : '/';
}

const hasActiveFilter = yearFilter || monthFilter;
---

<!doctype html>
<html lang="de">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body class="bg-[#faf8f3] text-gray-800">
		<Header />

		<!-- Hero Section -->
		<section class="relative overflow-hidden bg-gradient-to-br from-[#2d3e28] via-[#3a4f34] to-[#4a6741]">
			<!-- Background Pattern -->
			<div class="absolute inset-0 opacity-10">
				<svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
					<defs>
						<pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse">
							<path d="M 10 0 L 0 0 0 10" fill="none" stroke="white" stroke-width="0.5"/>
						</pattern>
					</defs>
					<rect width="100" height="100" fill="url(#grid)" />
				</svg>
			</div>

			<div class="relative max-w-6xl mx-auto px-4 py-16 md:py-24">
				<div class="max-w-2xl">
					<h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-white mb-6 leading-tight">
						{SITE_TITLE}
					</h1>
					<p class="text-xl md:text-2xl text-white/80 mb-8 leading-relaxed">
						{SITE_DESCRIPTION}
					</p>
					<div class="flex items-center gap-4">
						<div class="w-14 h-14 bg-[#c9a54e] rounded-full flex items-center justify-center shadow-lg">
							<svg class="w-8 h-8 text-[#2d3e28]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
							</svg>
						</div>
						<div>
							<p class="text-white font-semibold">{AUTHOR.name}</p>
							<p class="text-white/60 text-sm">{AUTHOR.experience}</p>
						</div>
					</div>
				</div>
			</div>

			<!-- Decorative Wave -->
			<div class="absolute bottom-0 left-0 right-0">
				<svg viewBox="0 0 1440 120" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full">
					<path d="M0 120L60 105C120 90 240 60 360 45C480 30 600 30 720 37.5C840 45 960 60 1080 67.5C1200 75 1320 75 1380 75L1440 75V120H1380C1320 120 1200 120 1080 120C960 120 840 120 720 120C600 120 480 120 360 120C240 120 120 120 60 120H0Z" fill="#faf8f3"/>
				</svg>
			</div>
		</section>

		<main class="max-w-6xl mx-auto px-4 py-12">
			<!-- Category Navigation -->
			<div class="mb-8">
				<CategoryNav showAll={true} />
			</div>

			<!-- Date Filter -->
			{sortedMonths.length > 0 && (
				<div class="mb-8">
					<form id="date-filter-form" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
						<div class="flex flex-col sm:flex-row sm:items-center gap-4">
							<div class="flex items-center gap-2 text-sm text-gray-600">
								<svg class="w-5 h-5 text-[#2d3e28]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
								</svg>
								<span class="font-medium">Filtern nach:</span>
							</div>
							<div class="flex flex-col sm:flex-row gap-3 flex-1">
								<select
									id="year-filter"
									name="jahr"
									class="px-4 py-2 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#4a6741] focus:border-transparent text-sm"
								>
									<option value="">Alle Jahre</option>
									{sortedYears.map((year) => (
										<option value={year.toString()} selected={yearFilter === year.toString()}>
											{year}
										</option>
									))}
								</select>
								<select
									id="month-filter"
									name="monat"
									class="px-4 py-2 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#4a6741] focus:border-transparent text-sm"
								>
									<option value="">Alle Monate</option>
									{sortedMonths.map((m) => (
										<option
											value={m.month.toString()}
											data-year={m.year}
											selected={yearFilter === m.year.toString() && monthFilter === m.month.toString()}
										>
											{m.label}
										</option>
									))}
								</select>
							</div>
							{hasActiveFilter && (
								<a
									href="/"
									class="inline-flex items-center gap-1 text-sm text-gray-500 hover:text-red-500 transition-colors"
								>
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
									</svg>
									Filter zurücksetzen
								</a>
							)}
						</div>
					</form>
				</div>
			)}

			<!-- Active Filter Info -->
			{hasActiveFilter && (
				<div class="mb-6 flex items-center gap-2">
					<span class="text-gray-600">
						{totalCount} {totalCount === 1 ? 'Artikel' : 'Artikel'} gefunden
						{yearFilter && !monthFilter && ` für ${yearFilter}`}
						{yearFilter && monthFilter && ` für ${sortedMonths.find(m => m.year.toString() === yearFilter && m.month.toString() === monthFilter)?.label}`}
					</span>
				</div>
			)}

			<!-- Coming Soon Section (if pending articles exist and no filter) -->
			{pendingTitles && pendingTitles.length > 0 && currentPage === 1 && !hasActiveFilter && (
				<section class="mb-16">
					<div class="flex items-center gap-3 mb-6">
						<span class="px-3 py-1 bg-[#c9a54e] text-[#2d3e28] text-sm font-bold rounded-full">
							Demnächst
						</span>
						<h2 class="text-xl font-bold text-[#2d3e28]">Neue Artikel in Vorbereitung</h2>
					</div>
					<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
						{pendingTitles.map((title) => (
							<ArticleCard
								id={title.id}
								title={title.title}
								description={title.description}
								category={title.category}
								imageUrl={title.image_url}
								isNew={true}
							/>
						))}
					</div>
				</section>
			)}

			<!-- Articles Grid -->
			{articles && articles.length > 0 ? (
				<>
					<section>
						<h2 class="text-2xl font-bold text-[#2d3e28] mb-8">
							{hasActiveFilter
								? 'Gefilterte Artikel'
								: currentPage === 1
									? 'Neueste Artikel'
									: `Artikel - Seite ${currentPage}`}
						</h2>
						<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
							{articles.map((article) => (
								<ArticleCard
									id={article.id}
									title={article.title}
									description={article.description}
									category={article.category}
									imageUrl={article.image_url}
									date={article.articles?.[0]?.generated_at || article.created_at}
								/>
							))}
						</div>
					</section>

					<!-- Pagination -->
					<div class="mt-12">
						<Pagination
							currentPage={currentPage}
							totalPages={totalPages}
							baseUrl={buildBaseUrl()}
						/>
					</div>
				</>
			) : (
				<div class="text-center py-20">
					<div class="w-24 h-24 bg-[#2d3e28]/10 rounded-full flex items-center justify-center mx-auto mb-6">
						<svg class="w-12 h-12 text-[#2d3e28]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
						</svg>
					</div>
					<h2 class="text-2xl font-bold text-[#2d3e28] mb-3">
						{hasActiveFilter ? 'Keine Artikel gefunden' : 'Noch keine Artikel vorhanden'}
					</h2>
					<p class="text-gray-600 max-w-md mx-auto mb-6">
						{hasActiveFilter
							? 'Für den gewählten Zeitraum sind keine Artikel vorhanden.'
							: 'Die ersten Beiträge werden bald erscheinen. Schauen Sie gerne wieder vorbei!'}
					</p>
					{hasActiveFilter && (
						<a
							href="/"
							class="inline-flex items-center gap-2 px-5 py-2.5 bg-[#2d3e28] text-white rounded-xl hover:bg-[#4a6741] transition-colors font-medium"
						>
							Alle Artikel anzeigen
						</a>
					)}
				</div>
			)}
		</main>

		<Footer />

		<script>
			const yearSelect = document.getElementById('year-filter') as HTMLSelectElement;
			const monthSelect = document.getElementById('month-filter') as HTMLSelectElement;

			function applyFilter() {
				const year = yearSelect.value;
				const month = monthSelect.value;

				const params = new URLSearchParams();
				if (year) params.set('jahr', year);
				if (month) {
					// Extract year from selected month option
					const selectedOption = monthSelect.options[monthSelect.selectedIndex];
					const optionYear = selectedOption.dataset.year;
					if (optionYear) {
						params.set('jahr', optionYear);
					}
					params.set('monat', month);
				}

				const queryString = params.toString();
				window.location.href = queryString ? `/?${queryString}` : '/';
			}

			yearSelect?.addEventListener('change', () => {
				// Reset month when year changes
				monthSelect.value = '';
				applyFilter();
			});

			monthSelect?.addEventListener('change', applyFilter);
		</script>
	</body>
</html>

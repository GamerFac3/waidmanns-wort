---
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import Badge from '../../components/ui/Badge.astro';
import RelatedArticles from '../../components/ui/RelatedArticles.astro';
import { SITE_TITLE, CATEGORIES, AUTHOR } from '../../consts';
import { supabase } from '../../lib/supabase';
import { renderMarkdown } from '../../lib/markdown';

const { id } = Astro.params;

if (!id) {
	return Astro.redirect('/');
}

// Get the title info
const { data: titleData, error: titleError } = await supabase
	.from('article_titles')
	.select('*')
	.eq('id', id)
	.single();

if (titleError || !titleData) {
	return Astro.redirect('/');
}

// Check if article already exists
const { data: articleData } = await supabase
	.from('articles')
	.select('*')
	.eq('title_id', id)
	.single();

const needsGeneration = !articleData;

// Get related articles (same category, exclude current)
const { data: relatedArticles } = await supabase
	.from('article_titles')
	.select('*')
	.eq('is_generated', true)
	.eq('category', titleData.category)
	.neq('id', id)
	.order('created_at', { ascending: false })
	.limit(3);

// Calculate reading time (approx. 200 words per minute)
function getReadingTime(content: string): number {
	const words = content?.split(/\s+/).length || 0;
	return Math.max(1, Math.ceil(words / 200));
}

const readingTime = articleData ? getReadingTime(articleData.content) : null;

const categoryInfo = CATEGORIES.find(c => c.id === titleData.category);
const categoryName = categoryInfo?.name || titleData.category;

function formatDate(dateStr: string): string {
	return new Date(dateStr).toLocaleDateString('de-DE', {
		year: 'numeric',
		month: 'long',
		day: 'numeric'
	});
}
---

<!doctype html>
<html lang="de">
	<head>
		<BaseHead title={`${titleData.title} | ${SITE_TITLE}`} description={titleData.description} />
	</head>
	<body class="bg-[#faf8f3] text-gray-800">
		<Header />

		<!-- Hero Section -->
		<section class="relative">
			{titleData.image_url ? (
				<div class="relative h-[50vh] min-h-[400px] max-h-[600px] overflow-hidden">
					<img
						src={titleData.image_url}
						alt={titleData.title}
						class="w-full h-full object-cover"
					/>
					<div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent" />
					<div class="absolute bottom-0 left-0 right-0 p-6 md:p-12">
						<div class="max-w-4xl mx-auto">
							<div class="flex items-center gap-3 mb-4">
								<a href={`/kategorien/${titleData.category}`}>
									<Badge>{categoryName}</Badge>
								</a>
								{articleData && (
									<>
										<span class="text-white/60">•</span>
										<span class="text-white/80 text-sm">{formatDate(articleData.generated_at)}</span>
									</>
								)}
								{readingTime && (
									<>
										<span class="text-white/60">•</span>
										<span class="text-white/80 text-sm">{readingTime} Min. Lesezeit</span>
									</>
								)}
							</div>
							<h1 class="text-3xl md:text-5xl font-bold text-white leading-tight">
								{titleData.title}
							</h1>
						</div>
					</div>
				</div>
			) : (
				<div class="bg-gradient-to-br from-[#2d3e28] to-[#4a6741] py-16 md:py-24">
					<div class="max-w-4xl mx-auto px-4">
						<div class="flex items-center gap-3 mb-4">
							<a href={`/kategorien/${titleData.category}`}>
								<Badge>{categoryName}</Badge>
							</a>
							{articleData && (
								<>
									<span class="text-white/60">•</span>
									<span class="text-white/80 text-sm">{formatDate(articleData.generated_at)}</span>
								</>
							)}
							{readingTime && (
								<>
									<span class="text-white/60">•</span>
									<span class="text-white/80 text-sm">{readingTime} Min. Lesezeit</span>
								</>
							)}
						</div>
						<h1 class="text-3xl md:text-5xl font-bold text-white leading-tight">
							{titleData.title}
						</h1>
					</div>
				</div>
			)}
		</section>

		<main class="max-w-4xl mx-auto px-4 py-8">
			<!-- Breadcrumb -->
			<nav class="flex items-center gap-2 text-sm text-gray-500 mb-8">
				<a href="/" class="hover:text-[#4a6741] transition-colors">Startseite</a>
				<span>/</span>
				<a href={`/kategorien/${titleData.category}`} class="hover:text-[#4a6741] transition-colors">
					{categoryName}
				</a>
				<span>/</span>
				<span class="text-gray-800 truncate max-w-[200px]">{titleData.title}</span>
			</nav>

			<article>
				<!-- Article Content -->
				<div id="article-content" class="bg-white rounded-2xl p-6 md:p-10 shadow-lg">
					{articleData ? (
						<div class="prose prose-lg max-w-none" set:html={renderMarkdown(articleData.content)} />
					) : (
						<div id="loading-state" class="flex items-center justify-center py-16">
							<div class="text-center">
								<div class="inline-block w-12 h-12 border-4 border-[#2d3e28] border-t-transparent rounded-full animate-spin mb-4"></div>
								<p class="text-gray-600">Artikel wird generiert...</p>
								<p class="text-gray-400 text-sm mt-2">Dies kann einen Moment dauern</p>
							</div>
						</div>
					)}
					<div id="streaming-content" class="hidden prose prose-lg max-w-none"></div>
				</div>

				{needsGeneration && (
					<script define:vars={{ articleId: id }}>
						// Simple markdown renderer for streaming content
						function renderMarkdown(text) {
							if (!text) return '';

							let html = text
								.trim()
								.replace(/\r\n/g, '\n')
								.replace(/\n{3,}/g, '\n\n');

							// Headers
							html = html.replace(/^### (.+)$/gm, '<h3 class="text-xl font-bold text-[#2d3e28] mt-8 mb-3">$1</h3>');
							html = html.replace(/^## (.+)$/gm, '<h2 class="text-2xl font-bold text-[#2d3e28] mt-8 mb-4 pt-4 border-t border-gray-200 first:border-t-0 first:pt-0 first:mt-0">$1</h2>');

							// Bold and italic
							html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
							html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
							html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

							// Process lists
							const lines = html.split('\n');
							const processed = [];
							let inList = false;

							for (let i = 0; i < lines.length; i++) {
								const line = lines[i];
								const isListItem = /^- (.+)$/.test(line);

								if (isListItem) {
									if (!inList) {
										processed.push('<ul class="list-disc pl-6 mb-4 space-y-1">');
										inList = true;
									}
									const content = line.replace(/^- (.+)$/, '$1');
									processed.push('<li>' + content + '</li>');
								} else {
									if (inList) {
										processed.push('</ul>');
										inList = false;
									}
									processed.push(line);
								}
							}
							if (inList) processed.push('</ul>');

							html = processed.join('\n');

							// Paragraphs
							const blocks = html.split('\n\n');
							const finalBlocks = blocks.map(block => {
								block = block.trim();
								if (!block) return '';
								if (block.startsWith('<h') || block.startsWith('<ul') || block.startsWith('<ol')) {
									return block;
								}
								if (!block.startsWith('<')) {
									return '<p class="mb-4 leading-relaxed">' + block.replace(/\n/g, '<br>') + '</p>';
								}
								return block;
							});

							return finalBlocks.filter(Boolean).join('\n');
						}

						async function streamArticle() {
							const loadingState = document.getElementById('loading-state');
							const streamingContent = document.getElementById('streaming-content');

							try {
								const response = await fetch('/api/generate-article?id=' + articleId);

								if (!response.ok) throw new Error('Failed to fetch article');

								if (loadingState) loadingState.classList.add('hidden');
								streamingContent.classList.remove('hidden');

								const reader = response.body.getReader();
								const decoder = new TextDecoder();
								let fullText = '';

								while (true) {
									const { done, value } = await reader.read();
									if (done) break;

									fullText += decoder.decode(value, { stream: true });
									streamingContent.innerHTML = renderMarkdown(fullText);
								}

								streamingContent.innerHTML = renderMarkdown(fullText);

							} catch (error) {
								console.error('Stream error:', error);
								streamingContent.innerHTML = '<p class="text-red-600">Fehler beim Laden des Artikels. Bitte laden Sie die Seite neu.</p>';
								streamingContent.classList.remove('hidden');
								if (loadingState) loadingState.classList.add('hidden');
							}
						}

						streamArticle();
					</script>
				)}

				<!-- Author Box -->
				<div class="mt-12 p-6 bg-[#2d3e28]/5 rounded-2xl">
					<div class="flex items-start gap-4">
						<div class="w-16 h-16 bg-[#c9a54e] rounded-full flex items-center justify-center flex-shrink-0">
							<svg class="w-8 h-8 text-[#2d3e28]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
							</svg>
						</div>
						<div>
							<p class="font-bold text-[#2d3e28] text-lg">{AUTHOR.name}</p>
							<p class="text-gray-600 text-sm mb-2">{AUTHOR.location} • {AUTHOR.experience}</p>
							<p class="text-gray-700 text-sm italic">Waidmannsheil!</p>
						</div>
					</div>
				</div>

				<!-- Share Buttons -->
				<div class="mt-8 flex items-center gap-4">
					<span class="text-sm font-medium text-gray-600">Teilen:</span>
					<div class="flex gap-2">
						<a
							href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(titleData.title)}&url=${encodeURIComponent(Astro.url.href)}`}
							target="_blank"
							rel="noopener noreferrer"
							class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-md hover:shadow-lg hover:-translate-y-0.5 transition-all"
							aria-label="Auf Twitter teilen"
						>
							<svg class="w-5 h-5 text-gray-700" fill="currentColor" viewBox="0 0 24 24">
								<path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
							</svg>
						</a>
						<a
							href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.href)}`}
							target="_blank"
							rel="noopener noreferrer"
							class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-md hover:shadow-lg hover:-translate-y-0.5 transition-all"
							aria-label="Auf Facebook teilen"
						>
							<svg class="w-5 h-5 text-gray-700" fill="currentColor" viewBox="0 0 24 24">
								<path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
							</svg>
						</a>
						<a
							href={`mailto:?subject=${encodeURIComponent(titleData.title)}&body=${encodeURIComponent(Astro.url.href)}`}
							class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-md hover:shadow-lg hover:-translate-y-0.5 transition-all"
							aria-label="Per E-Mail teilen"
						>
							<svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
							</svg>
						</a>
					</div>
				</div>
			</article>

			<!-- Related Articles -->
			{relatedArticles && relatedArticles.length > 0 && (
				<RelatedArticles articles={relatedArticles} />
			)}
		</main>

		<Footer />
	</body>
</html>

<style>
	@reference "tailwindcss";

	.prose h2 {
		@apply text-2xl font-bold text-[#2d3e28] mt-10 mb-4 pt-6 border-t border-gray-200;
	}
	.prose h2:first-child {
		@apply border-t-0 pt-0 mt-0;
	}
	.prose h3 {
		@apply text-xl font-bold text-[#2d3e28] mt-8 mb-3;
	}
	.prose p {
		@apply mb-4 leading-relaxed text-gray-700;
	}
	.prose ul {
		@apply list-disc pl-6 mb-4 space-y-2;
	}
	.prose li {
		@apply text-gray-700;
	}
	.prose strong {
		@apply font-semibold text-gray-900;
	}
</style>

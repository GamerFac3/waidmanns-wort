---
import BaseHead from '../../components/BaseHead.astro';
import { SITE_TITLE } from '../../consts';
import { getUser } from '../../lib/supabase';

// If already logged in, redirect to admin
const user = await getUser(Astro.cookies);
if (user) {
	return Astro.redirect('/admin');
}
---

<!doctype html>
<html lang="de">
	<head>
		<BaseHead title={`Login | ${SITE_TITLE}`} description="Admin Login" />
	</head>
	<body class="bg-[#f5f0e6] min-h-screen flex items-center justify-center">
		<div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
			<h1 class="text-2xl font-bold text-[#2d3e28] mb-6 text-center">Admin Login</h1>

			<div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>

			<form id="login-form" class="space-y-4">
				<div>
					<label for="email" class="block text-sm font-medium text-gray-700 mb-1">E-Mail</label>
					<input
						type="email"
						id="email"
						name="email"
						required
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#4a6741]"
					/>
				</div>

				<div>
					<label for="password" class="block text-sm font-medium text-gray-700 mb-1">Passwort</label>
					<input
						type="password"
						id="password"
						name="password"
						required
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#4a6741]"
					/>
				</div>

				<button
					type="submit"
					id="submit-btn"
					class="w-full bg-[#2d3e28] text-white py-2 px-4 rounded-md hover:bg-[#4a6741] transition-colors"
				>
					Anmelden
				</button>
			</form>

			<p class="mt-4 text-center text-sm text-gray-500">
				<a href="/" class="text-[#4a6741] hover:underline">&larr; Zur√ºck zur Website</a>
			</p>
		</div>

		<script>
			const form = document.getElementById('login-form') as HTMLFormElement;
			const errorDiv = document.getElementById('error-message') as HTMLDivElement;
			const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

			form.addEventListener('submit', async (e) => {
				e.preventDefault();

				const email = (document.getElementById('email') as HTMLInputElement).value;
				const password = (document.getElementById('password') as HTMLInputElement).value;

				submitBtn.disabled = true;
				submitBtn.textContent = 'Wird angemeldet...';
				errorDiv.classList.add('hidden');

				try {
					const response = await fetch('/api/auth/signin', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ email, password }),
					});

					const data = await response.json();

					if (!response.ok) {
						throw new Error(data.error || 'Login fehlgeschlagen');
					}

					window.location.href = '/admin';
				} catch (error) {
					errorDiv.textContent = (error as Error).message;
					errorDiv.classList.remove('hidden');
					submitBtn.disabled = false;
					submitBtn.textContent = 'Anmelden';
				}
			});
		</script>
	</body>
</html>

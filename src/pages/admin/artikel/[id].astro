---
import AdminLayout from '../../../components/AdminLayout.astro';
import { getUser, supabase } from '../../../lib/supabase';
import { CATEGORIES } from '../../../consts';

const user = await getUser(Astro.cookies);
if (!user) {
	return Astro.redirect('/admin/login');
}

const { id } = Astro.params;

// Get article data
const { data: article, error } = await supabase
	.from('article_titles')
	.select(`
		*,
		articles (id, content, generated_at)
	`)
	.eq('id', id)
	.single();

if (error || !article) {
	return Astro.redirect('/admin/artikel');
}

const articleContent = article.articles?.[0];

function formatDate(dateStr: string): string {
	return new Date(dateStr).toLocaleDateString('de-DE', {
		day: '2-digit',
		month: '2-digit',
		year: 'numeric',
		hour: '2-digit',
		minute: '2-digit'
	});
}
---

<AdminLayout title={article.title}>
	<!-- Mobile Title -->
	<h1 class="text-2xl font-bold text-[#2d3e28] mb-6 lg:hidden line-clamp-2">{article.title}</h1>

	<div class="max-w-4xl">
		<!-- Breadcrumb -->
		<nav class="flex items-center gap-2 text-sm text-gray-500 mb-6">
			<a href="/admin/artikel" class="hover:text-[#4a6741] transition-colors">Artikel</a>
			<svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
			</svg>
			<span class="text-[#2d3e28] font-medium truncate max-w-[200px]">{article.title}</span>
		</nav>

		<!-- Status Bar -->
		<div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 mb-6">
			<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
				<div class="flex items-center gap-3">
					<span class:list={[
						"px-3 py-1.5 text-sm font-medium rounded-full",
						article.is_generated
							? 'bg-green-100 text-green-700'
							: 'bg-orange-100 text-orange-700'
					]}>
						{article.is_generated ? 'Generiert' : 'Ausstehend'}
					</span>
					{articleContent && (
						<span class="text-sm text-gray-500">
							Generiert am {formatDate(articleContent.generated_at)}
						</span>
					)}
				</div>
				<a
					href={`/artikel/${id}`}
					target="_blank"
					class="inline-flex items-center gap-2 text-[#4a6741] hover:text-[#2d3e28] transition-colors font-medium"
				>
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
					</svg>
					Artikel ansehen
				</a>
			</div>
		</div>

		<form id="article-form" class="space-y-6">
			<input type="hidden" id="article-id" value={id} />

			<!-- Main Card -->
			<div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
				<div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
					<h2 class="font-semibold text-[#2d3e28]">Artikelinformationen</h2>
				</div>
				<div class="p-6 space-y-6">
					<div>
						<label for="title" class="block text-sm font-medium text-gray-700 mb-2">
							Titel <span class="text-red-500">*</span>
						</label>
						<input
							type="text"
							id="title"
							name="title"
							required
							value={article.title}
							class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#4a6741] focus:border-transparent transition-all"
						/>
					</div>

					<div>
						<label for="description" class="block text-sm font-medium text-gray-700 mb-2">
							Beschreibung <span class="text-red-500">*</span>
						</label>
						<textarea
							id="description"
							name="description"
							required
							rows="3"
							class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#4a6741] focus:border-transparent transition-all resize-none"
						>{article.description}</textarea>
					</div>

					<div>
						<label for="category" class="block text-sm font-medium text-gray-700 mb-2">
							Kategorie <span class="text-red-500">*</span>
						</label>
						<select
							id="category"
							name="category"
							required
							class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#4a6741] focus:border-transparent transition-all"
						>
							{CATEGORIES.map(cat => (
								<option value={cat.id} selected={cat.id === article.category}>{cat.name}</option>
							))}
						</select>
					</div>
				</div>
			</div>

			<!-- Image Card -->
			<div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
				<div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex items-center justify-between">
					<h2 class="font-semibold text-[#2d3e28]">Titelbild</h2>
					<button
						type="button"
						id="generate-image-btn"
						class="inline-flex items-center gap-2 px-4 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 transition-colors"
					>
						<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
						</svg>
						Mit KI generieren
					</button>
				</div>
				<div class="p-6">
					<!-- AI Generation Progress -->
					<div id="ai-generation-progress" class="hidden mb-4">
						<div class="bg-purple-50 border border-purple-200 rounded-xl p-4">
							<div class="flex items-center gap-3">
								<svg class="w-6 h-6 text-purple-500 animate-spin" fill="none" viewBox="0 0 24 24">
									<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
									<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
								</svg>
								<div>
									<p class="text-purple-700 font-medium">Bild wird generiert...</p>
									<p id="ai-generation-status" class="text-purple-600 text-sm">Erstelle Bildprompt mit Claude...</p>
								</div>
							</div>
						</div>
					</div>

					{article.image_url && (
						<div id="current-image-container" class="mb-4">
							<img
								src={article.image_url}
								alt="Aktuelles Bild"
								class="w-full max-w-md h-48 object-cover rounded-xl"
							/>
							<button
								type="button"
								id="remove-current-image"
								class="mt-3 text-red-500 hover:text-red-600 text-sm font-medium inline-flex items-center gap-1"
							>
								<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
								</svg>
								Bild entfernen
							</button>
						</div>
					)}
					<div id="image-upload-area" class:list={[
						"border-2 border-dashed border-gray-200 rounded-xl p-8 text-center hover:border-[#4a6741] hover:bg-[#4a6741]/5 transition-all cursor-pointer",
						article.image_url && "hidden"
					]}>
						<input
							type="file"
							id="image"
							name="image"
							accept="image/*"
							class="hidden"
						/>
						<div id="upload-placeholder">
							<div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
								<svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
								</svg>
							</div>
							<p class="text-gray-600 font-medium mb-1">
								{article.image_url ? 'Neues Bild hochladen' : 'Klicken oder Bild hierher ziehen'}
							</p>
							<p class="text-gray-400 text-sm mb-3">PNG, JPG, GIF bis 5MB</p>
							<p class="text-purple-600 text-sm">
								oder <button type="button" class="font-medium underline generate-image-trigger">mit KI generieren</button>
							</p>
						</div>
						<div id="image-preview" class="hidden">
							<img id="preview-img" src="" alt="Vorschau" class="max-h-48 mx-auto rounded-lg mb-4" />
							<button type="button" id="remove-image" class="text-red-500 hover:text-red-600 text-sm font-medium">
								Bild entfernen
							</button>
						</div>
					</div>
					<input type="hidden" id="current-image" value={article.image_url || ''} />
					<input type="hidden" id="remove-image-flag" value="false" />
				</div>
			</div>

			<!-- Content Card -->
			{articleContent ? (
				<div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
					<div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex items-center justify-between">
						<h2 class="font-semibold text-[#2d3e28]">Artikelinhalt</h2>
						<button
							type="button"
							id="regenerate-btn"
							class="inline-flex items-center gap-2 px-4 py-2 bg-orange-500 text-white text-sm rounded-lg hover:bg-orange-600 transition-colors"
						>
							<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
							</svg>
							Neu generieren
						</button>
					</div>
					<div class="p-6">
						<textarea
							id="content"
							name="content"
							rows="20"
							class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#4a6741] focus:border-transparent transition-all font-mono text-sm"
						>{articleContent.content}</textarea>
					</div>
				</div>
			) : (
				<div class="bg-orange-50 border-2 border-orange-200 rounded-2xl p-6">
					<div class="flex items-start gap-4">
						<div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center flex-shrink-0">
							<svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
							</svg>
						</div>
						<div>
							<h3 class="font-semibold text-orange-800 mb-1">Inhalt noch nicht generiert</h3>
							<p class="text-orange-700 text-sm mb-3">
								Der Artikelinhalt wurde noch nicht generiert. Besuchen Sie die Artikelseite, um die Generierung zu starten.
							</p>
							<a
								href={`/artikel/${id}`}
								target="_blank"
								class="inline-flex items-center gap-2 text-orange-800 hover:text-orange-900 font-medium text-sm"
							>
								Artikel aufrufen
								<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
								</svg>
							</a>
						</div>
					</div>
				</div>
			)}

			<!-- Actions -->
			<div class="flex flex-col sm:flex-row items-center justify-between gap-4 pt-4">
				<a
					href="/admin/artikel"
					class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-5 py-2.5 text-gray-600 hover:text-gray-800 transition-colors"
				>
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
					</svg>
					Zurück zur Liste
				</a>
				<button
					type="submit"
					class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-2.5 bg-[#2d3e28] text-white rounded-xl hover:bg-[#4a6741] transition-all font-medium"
				>
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
					</svg>
					Änderungen speichern
				</button>
			</div>
		</form>
	</div>

	<script>
		import { createClient } from '@supabase/supabase-js';

		const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
		const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
		const supabase = createClient(supabaseUrl, supabaseAnonKey);

		const form = document.getElementById('article-form') as HTMLFormElement;
		const articleId = (document.getElementById('article-id') as HTMLInputElement).value;
		const imageInput = document.getElementById('image') as HTMLInputElement;
		const uploadArea = document.getElementById('image-upload-area') as HTMLDivElement;
		const uploadPlaceholder = document.getElementById('upload-placeholder') as HTMLDivElement;
		const imagePreview = document.getElementById('image-preview') as HTMLDivElement;
		const previewImg = document.getElementById('preview-img') as HTMLImageElement;
		const removeImageBtn = document.getElementById('remove-image');
		const currentImageContainer = document.getElementById('current-image-container');
		const removeCurrentImageBtn = document.getElementById('remove-current-image');
		const removeImageFlag = document.getElementById('remove-image-flag') as HTMLInputElement;
		const regenerateBtn = document.getElementById('regenerate-btn');

		// Remove current image
		removeCurrentImageBtn?.addEventListener('click', () => {
			removeImageFlag.value = 'true';
			currentImageContainer?.remove();
			uploadArea?.classList.remove('hidden');
		});

		// Click to upload
		uploadArea?.addEventListener('click', () => {
			imageInput.click();
		});

		// Drag and drop
		uploadArea?.addEventListener('dragover', (e) => {
			e.preventDefault();
			uploadArea.classList.add('border-[#4a6741]', 'bg-[#4a6741]/5');
		});

		uploadArea?.addEventListener('dragleave', () => {
			uploadArea.classList.remove('border-[#4a6741]', 'bg-[#4a6741]/5');
		});

		uploadArea?.addEventListener('drop', (e) => {
			e.preventDefault();
			uploadArea.classList.remove('border-[#4a6741]', 'bg-[#4a6741]/5');
			const files = e.dataTransfer?.files;
			if (files && files.length > 0) {
				imageInput.files = files;
				showPreview(files[0]);
			}
		});

		// File input change
		imageInput?.addEventListener('change', () => {
			const file = imageInput.files?.[0];
			if (file) {
				showPreview(file);
			}
		});

		// Show preview
		function showPreview(file: File) {
			const reader = new FileReader();
			reader.onload = (e) => {
				if (previewImg) previewImg.src = e.target?.result as string;
				uploadPlaceholder?.classList.add('hidden');
				imagePreview?.classList.remove('hidden');
			};
			reader.readAsDataURL(file);
		}

		// Remove new image preview
		removeImageBtn?.addEventListener('click', (e) => {
			e.stopPropagation();
			imageInput.value = '';
			if (previewImg) previewImg.src = '';
			uploadPlaceholder?.classList.remove('hidden');
			imagePreview?.classList.add('hidden');
		});

		// Regenerate button
		regenerateBtn?.addEventListener('click', async () => {
			if (!confirm('Artikelinhalt neu generieren? Der aktuelle Inhalt wird überschrieben.')) return;

			const btn = regenerateBtn as HTMLButtonElement;
			btn.disabled = true;
			btn.innerHTML = `
				<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
					<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
					<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
				</svg>
				Generiert...
			`;

			try {
				const response = await fetch(`/api/admin/artikel/${articleId}/regenerate`, { method: 'POST' });
				if (response.ok) {
					window.location.reload();
				} else {
					throw new Error('Fehler beim Regenerieren');
				}
			} catch (error) {
				alert('Fehler: ' + (error as Error).message);
				btn.disabled = false;
				btn.innerHTML = `
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
					</svg>
					Neu generieren
				`;
			}
		});

		// AI Image Generation
		const generateImageBtn = document.getElementById('generate-image-btn');
		const aiGenerationProgress = document.getElementById('ai-generation-progress');
		const aiGenerationStatus = document.getElementById('ai-generation-status');
		const generateImageTriggers = document.querySelectorAll('.generate-image-trigger');

		async function generateImage() {
			if (!confirm('Titelbild mit KI generieren? Dies kann einige Sekunden dauern.')) return;

			const btn = generateImageBtn as HTMLButtonElement;
			btn.disabled = true;
			btn.innerHTML = `
				<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
					<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
					<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
				</svg>
				Generiert...
			`;

			aiGenerationProgress?.classList.remove('hidden');
			if (aiGenerationStatus) aiGenerationStatus.textContent = 'Erstelle Bildprompt mit Claude...';

			try {
				const response = await fetch(`/api/admin/artikel/${articleId}/generate-image`, {
					method: 'POST'
				});

				const data = await response.json();

				if (!response.ok) {
					if (response.status === 503) {
						// Replicate API not configured
						alert(`REPLICATE_API_TOKEN nicht konfiguriert.\n\nGenerierter Prompt:\n${data.prompt}`);
					} else {
						throw new Error(data.error || 'Fehler bei der Bildgenerierung');
					}
					return;
				}

				if (aiGenerationStatus) aiGenerationStatus.textContent = 'Bild erfolgreich generiert!';

				// Reload to show new image
				setTimeout(() => {
					window.location.reload();
				}, 500);

			} catch (error) {
				alert('Fehler: ' + (error as Error).message);
			} finally {
				aiGenerationProgress?.classList.add('hidden');
				btn.disabled = false;
				btn.innerHTML = `
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
					</svg>
					Mit KI generieren
				`;
			}
		}

		generateImageBtn?.addEventListener('click', generateImage);
		generateImageTriggers.forEach(trigger => {
			trigger.addEventListener('click', (e) => {
				e.preventDefault();
				e.stopPropagation();
				generateImage();
			});
		});

		// Form submit
		form?.addEventListener('submit', async (e) => {
			e.preventDefault();

			const formData = new FormData(form);
			const title = formData.get('title') as string;
			const description = formData.get('description') as string;
			const category = formData.get('category') as string;
			const content = formData.get('content') as string;
			const imageFile = imageInput?.files?.[0];
			const removeImage = removeImageFlag.value === 'true';
			let imageUrl = (document.getElementById('current-image') as HTMLInputElement).value;

			const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
			submitBtn.disabled = true;
			submitBtn.innerHTML = `
				<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
					<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
					<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
				</svg>
				Speichert...
			`;

			try {
				// Handle image
				if (removeImage) {
					imageUrl = '';
				} else if (imageFile && imageFile.size > 0) {
					const fileName = `${Date.now()}-${imageFile.name}`;
					const { error: uploadError } = await supabase.storage
						.from('article-images')
						.upload(fileName, imageFile);

					if (uploadError) throw uploadError;

					const { data: { publicUrl } } = supabase.storage
						.from('article-images')
						.getPublicUrl(fileName);

					imageUrl = publicUrl;
				}

				// Update article via API
				const response = await fetch(`/api/admin/artikel/${articleId}`, {
					method: 'PUT',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ title, description, category, content, image_url: imageUrl }),
				});

				if (!response.ok) {
					const data = await response.json();
					throw new Error(data.error || 'Fehler beim Speichern');
				}

				window.location.href = '/admin/artikel';
			} catch (error) {
				alert('Fehler: ' + (error as Error).message);
				submitBtn.disabled = false;
				submitBtn.innerHTML = `
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
					</svg>
					Änderungen speichern
				`;
			}
		});
	</script>
</AdminLayout>

<style>
	@reference "tailwindcss";

	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>

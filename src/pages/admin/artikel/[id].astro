---
import AdminLayout from '../../../components/AdminLayout.astro';
import { getUser, supabase } from '../../../lib/supabase';
import { CATEGORIES } from '../../../consts';

const user = await getUser(Astro.cookies);
if (!user) {
	return Astro.redirect('/admin/login');
}

const { id } = Astro.params;

// Get article data
const { data: article, error } = await supabase
	.from('article_titles')
	.select(`
		*,
		articles (id, content, generated_at)
	`)
	.eq('id', id)
	.single();

if (error || !article) {
	return Astro.redirect('/admin/artikel');
}

const articleContent = article.articles?.[0];
---

<AdminLayout title={`Bearbeiten: ${article.title}`}>
	<div class="max-w-4xl">
		<div class="flex justify-between items-center mb-8">
			<h1 class="text-3xl font-bold text-gray-800">Artikel bearbeiten</h1>
			<a href={`/artikel/${id}`} target="_blank" class="text-[#4a6741] hover:underline">
				Artikel ansehen &rarr;
			</a>
		</div>

		<form id="article-form" class="bg-white rounded-lg shadow p-6 space-y-6">
			<input type="hidden" id="article-id" value={id} />

			<div>
				<label for="title" class="block text-sm font-medium text-gray-700 mb-1">Titel *</label>
				<input
					type="text"
					id="title"
					name="title"
					required
					value={article.title}
					class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#4a6741]"
				/>
			</div>

			<div>
				<label for="description" class="block text-sm font-medium text-gray-700 mb-1">Beschreibung *</label>
				<textarea
					id="description"
					name="description"
					required
					rows="2"
					class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#4a6741]"
				>{article.description}</textarea>
			</div>

			<div>
				<label for="category" class="block text-sm font-medium text-gray-700 mb-1">Kategorie *</label>
				<select
					id="category"
					name="category"
					required
					class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#4a6741]"
				>
					{CATEGORIES.map(cat => (
						<option value={cat.id} selected={cat.id === article.category}>{cat.name}</option>
					))}
				</select>
			</div>

			<div>
				<label class="block text-sm font-medium text-gray-700 mb-1">Bild</label>
				{article.image_url && (
					<div class="mb-3">
						<img src={article.image_url} alt="" class="w-48 h-32 object-cover rounded" />
						<button
							type="button"
							id="remove-image-btn"
							class="text-red-600 text-sm hover:underline mt-1"
						>
							Bild entfernen
						</button>
					</div>
				)}
				<input
					type="file"
					id="image"
					name="image"
					accept="image/*"
					class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#4a6741]"
				/>
				<input type="hidden" id="current-image" value={article.image_url || ''} />
				<input type="hidden" id="remove-image" value="false" />
			</div>

			{articleContent ? (
				<div>
					<label for="content" class="block text-sm font-medium text-gray-700 mb-1">
						Inhalt
						<span class="text-gray-400 font-normal ml-2">
							(Generiert am {new Date(articleContent.generated_at).toLocaleDateString('de-DE')})
						</span>
					</label>
					<textarea
						id="content"
						name="content"
						rows="20"
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#4a6741] font-mono text-sm"
					>{articleContent.content}</textarea>
				</div>
			) : (
				<div class="bg-orange-50 border border-orange-200 rounded p-4">
					<p class="text-orange-700">
						Der Artikelinhalt wurde noch nicht generiert.
						<a href={`/artikel/${id}`} class="underline" target="_blank">Artikel aufrufen um zu generieren</a>
					</p>
				</div>
			)}

			<div class="pt-4 border-t flex justify-between items-center">
				<a href="/admin/artikel" class="text-gray-500 hover:text-gray-700">Zurück zur Liste</a>
				<div class="space-x-3">
					{articleContent && (
						<button
							type="button"
							id="regenerate-btn"
							class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 transition-colors"
						>
							Neu generieren
						</button>
					)}
					<button
						type="submit"
						class="bg-[#2d3e28] text-white px-6 py-2 rounded hover:bg-[#4a6741] transition-colors"
					>
						Speichern
					</button>
				</div>
			</div>
		</form>
	</div>

	<script>
		import { createClient } from '@supabase/supabase-js';

		const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
		const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
		const supabase = createClient(supabaseUrl, supabaseAnonKey);

		const form = document.getElementById('article-form') as HTMLFormElement;
		const articleId = (document.getElementById('article-id') as HTMLInputElement).value;
		const removeImageInput = document.getElementById('remove-image') as HTMLInputElement;
		const removeImageBtn = document.getElementById('remove-image-btn');
		const regenerateBtn = document.getElementById('regenerate-btn');

		// Remove image button
		removeImageBtn?.addEventListener('click', () => {
			removeImageInput.value = 'true';
			removeImageBtn.parentElement?.remove();
		});

		// Regenerate button
		regenerateBtn?.addEventListener('click', async () => {
			if (!confirm('Artikelinhalt neu generieren? Der aktuelle Inhalt wird überschrieben.')) return;

			regenerateBtn.disabled = true;
			regenerateBtn.textContent = 'Wird generiert...';

			try {
				const response = await fetch(`/api/admin/artikel/${articleId}/regenerate`, { method: 'POST' });
				if (response.ok) {
					window.location.reload();
				} else {
					throw new Error('Fehler beim Regenerieren');
				}
			} catch (error) {
				alert('Fehler: ' + (error as Error).message);
				regenerateBtn.disabled = false;
				regenerateBtn.textContent = 'Neu generieren';
			}
		});

		// Form submit
		form.addEventListener('submit', async (e) => {
			e.preventDefault();

			const formData = new FormData(form);
			const title = formData.get('title') as string;
			const description = formData.get('description') as string;
			const category = formData.get('category') as string;
			const content = formData.get('content') as string;
			const imageFile = formData.get('image') as File;
			const removeImage = removeImageInput.value === 'true';
			let imageUrl = (document.getElementById('current-image') as HTMLInputElement).value;

			const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
			submitBtn.disabled = true;
			submitBtn.textContent = 'Speichert...';

			try {
				// Handle image
				if (removeImage) {
					imageUrl = '';
				} else if (imageFile && imageFile.size > 0) {
					const fileName = `${Date.now()}-${imageFile.name}`;
					const { error: uploadError } = await supabase.storage
						.from('article-images')
						.upload(fileName, imageFile);

					if (uploadError) throw uploadError;

					const { data: { publicUrl } } = supabase.storage
						.from('article-images')
						.getPublicUrl(fileName);

					imageUrl = publicUrl;
				}

				// Update article via API
				const response = await fetch(`/api/admin/artikel/${articleId}`, {
					method: 'PUT',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ title, description, category, content, image_url: imageUrl }),
				});

				if (!response.ok) {
					const data = await response.json();
					throw new Error(data.error || 'Fehler beim Speichern');
				}

				window.location.href = '/admin/artikel';
			} catch (error) {
				alert('Fehler: ' + (error as Error).message);
				submitBtn.disabled = false;
				submitBtn.textContent = 'Speichern';
			}
		});
	</script>
</AdminLayout>

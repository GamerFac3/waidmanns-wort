---
import AdminLayout from '../../../components/AdminLayout.astro';
import { getUser } from '../../../lib/supabase';
import { CATEGORIES } from '../../../consts';

const user = await getUser(Astro.cookies);
if (!user) {
	return Astro.redirect('/admin/login');
}
---

<AdminLayout title="Neuer Artikel">
	<!-- Mobile Title -->
	<h1 class="text-2xl font-bold text-[#2d3e28] mb-6 lg:hidden">Neuer Artikel</h1>

	<div class="max-w-3xl">
		<!-- Breadcrumb -->
		<nav class="flex items-center gap-2 text-sm text-gray-500 mb-6">
			<a href="/admin/artikel" class="hover:text-[#4a6741] transition-colors">Artikel</a>
			<svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
			</svg>
			<span class="text-[#2d3e28] font-medium">Neuer Artikel</span>
		</nav>

		<form id="article-form" class="space-y-6">
			<!-- Main Card -->
			<div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
				<div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
					<h2 class="font-semibold text-[#2d3e28]">Artikelinformationen</h2>
				</div>
				<div class="p-6 space-y-6">
					<div>
						<label for="title" class="block text-sm font-medium text-gray-700 mb-2">
							Titel <span class="text-red-500">*</span>
						</label>
						<input
							type="text"
							id="title"
							name="title"
							required
							class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#4a6741] focus:border-transparent transition-all"
							placeholder="Der Titel des Artikels"
						/>
					</div>

					<div>
						<label for="description" class="block text-sm font-medium text-gray-700 mb-2">
							Beschreibung <span class="text-red-500">*</span>
						</label>
						<textarea
							id="description"
							name="description"
							required
							rows="3"
							class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#4a6741] focus:border-transparent transition-all resize-none"
							placeholder="Kurze Beschreibung des Artikels (wird in der Vorschau angezeigt)"
						></textarea>
					</div>

					<div>
						<label for="category" class="block text-sm font-medium text-gray-700 mb-2">
							Kategorie <span class="text-red-500">*</span>
						</label>
						<select
							id="category"
							name="category"
							required
							class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#4a6741] focus:border-transparent transition-all"
						>
							<option value="">Kategorie wählen...</option>
							{CATEGORIES.map(cat => (
								<option value={cat.id}>{cat.name}</option>
							))}
						</select>
					</div>
				</div>
			</div>

			<!-- Image Card -->
			<div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
				<div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
					<h2 class="font-semibold text-[#2d3e28]">Titelbild</h2>
					<p class="text-sm text-gray-500 mt-1">Optional: Ein Bild für den Artikel hochladen</p>
				</div>
				<div class="p-6">
					<div id="image-upload-area" class="border-2 border-dashed border-gray-200 rounded-xl p-8 text-center hover:border-[#4a6741] hover:bg-[#4a6741]/5 transition-all cursor-pointer">
						<input
							type="file"
							id="image"
							name="image"
							accept="image/*"
							class="hidden"
						/>
						<div id="upload-placeholder">
							<div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
								<svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
								</svg>
							</div>
							<p class="text-gray-600 font-medium mb-1">Klicken Sie hier oder ziehen Sie ein Bild hinein</p>
							<p class="text-gray-400 text-sm">PNG, JPG, GIF bis 5MB</p>
						</div>
						<div id="image-preview" class="hidden">
							<img id="preview-img" src="" alt="Vorschau" class="max-h-48 mx-auto rounded-lg mb-4" />
							<button type="button" id="remove-image" class="text-red-500 hover:text-red-600 text-sm font-medium">
								Bild entfernen
							</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Actions -->
			<div class="flex flex-col sm:flex-row items-center justify-between gap-4 pt-4">
				<a
					href="/admin/artikel"
					class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-5 py-2.5 text-gray-600 hover:text-gray-800 transition-colors"
				>
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
					</svg>
					Abbrechen
				</a>
				<div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
					<button
						type="submit"
						name="action"
						value="save"
						class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-2.5 bg-white border-2 border-[#2d3e28] text-[#2d3e28] rounded-xl hover:bg-[#2d3e28] hover:text-white transition-all font-medium"
					>
						<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
						</svg>
						Speichern
					</button>
					<button
						type="submit"
						name="action"
						value="generate"
						class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-2.5 bg-[#c9a54e] text-[#2d3e28] rounded-xl hover:bg-[#b8943d] transition-all font-semibold"
					>
						<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
						</svg>
						Speichern & Generieren
					</button>
				</div>
			</div>
		</form>
	</div>

	<script>
		import { createClient } from '@supabase/supabase-js';

		const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
		const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
		const supabase = createClient(supabaseUrl, supabaseAnonKey);

		const form = document.getElementById('article-form') as HTMLFormElement;
		const imageInput = document.getElementById('image') as HTMLInputElement;
		const uploadArea = document.getElementById('image-upload-area') as HTMLDivElement;
		const uploadPlaceholder = document.getElementById('upload-placeholder') as HTMLDivElement;
		const imagePreview = document.getElementById('image-preview') as HTMLDivElement;
		const previewImg = document.getElementById('preview-img') as HTMLImageElement;
		const removeImageBtn = document.getElementById('remove-image') as HTMLButtonElement;

		// Click to upload
		uploadArea.addEventListener('click', () => {
			imageInput.click();
		});

		// Drag and drop
		uploadArea.addEventListener('dragover', (e) => {
			e.preventDefault();
			uploadArea.classList.add('border-[#4a6741]', 'bg-[#4a6741]/5');
		});

		uploadArea.addEventListener('dragleave', () => {
			uploadArea.classList.remove('border-[#4a6741]', 'bg-[#4a6741]/5');
		});

		uploadArea.addEventListener('drop', (e) => {
			e.preventDefault();
			uploadArea.classList.remove('border-[#4a6741]', 'bg-[#4a6741]/5');
			const files = e.dataTransfer?.files;
			if (files && files.length > 0) {
				imageInput.files = files;
				showPreview(files[0]);
			}
		});

		// File input change
		imageInput.addEventListener('change', () => {
			const file = imageInput.files?.[0];
			if (file) {
				showPreview(file);
			}
		});

		// Show preview
		function showPreview(file: File) {
			const reader = new FileReader();
			reader.onload = (e) => {
				previewImg.src = e.target?.result as string;
				uploadPlaceholder.classList.add('hidden');
				imagePreview.classList.remove('hidden');
			};
			reader.readAsDataURL(file);
		}

		// Remove image
		removeImageBtn.addEventListener('click', (e) => {
			e.stopPropagation();
			imageInput.value = '';
			previewImg.src = '';
			uploadPlaceholder.classList.remove('hidden');
			imagePreview.classList.add('hidden');
		});

		// Form submit
		form.addEventListener('submit', async (e) => {
			e.preventDefault();

			const formData = new FormData(form);
			const title = formData.get('title') as string;
			const description = formData.get('description') as string;
			const category = formData.get('category') as string;
			const imageFile = imageInput.files?.[0];
			const action = (e.submitter as HTMLButtonElement).value;

			const submitBtns = form.querySelectorAll('button[type="submit"]');
			submitBtns.forEach(btn => {
				(btn as HTMLButtonElement).disabled = true;
				btn.classList.add('opacity-50', 'cursor-not-allowed');
			});

			try {
				// Upload image if provided
				let imageUrl = null;
				if (imageFile && imageFile.size > 0) {
					const fileName = `${Date.now()}-${imageFile.name}`;
					const { data: uploadData, error: uploadError } = await supabase.storage
						.from('article-images')
						.upload(fileName, imageFile);

					if (uploadError) throw uploadError;

					const { data: { publicUrl } } = supabase.storage
						.from('article-images')
						.getPublicUrl(fileName);

					imageUrl = publicUrl;
				}

				// Create article via API
				const response = await fetch('/api/admin/artikel', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ title, description, category, image_url: imageUrl }),
				});

				const data = await response.json();

				if (!response.ok) {
					throw new Error(data.error || 'Fehler beim Erstellen');
				}

				if (action === 'generate') {
					// Redirect to article page to trigger generation
					window.location.href = `/artikel/${data.id}`;
				} else {
					window.location.href = '/admin/artikel';
				}
			} catch (error) {
				alert('Fehler: ' + (error as Error).message);
				submitBtns.forEach(btn => {
					(btn as HTMLButtonElement).disabled = false;
					btn.classList.remove('opacity-50', 'cursor-not-allowed');
				});
			}
		});
	</script>
</AdminLayout>

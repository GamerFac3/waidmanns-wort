---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import ArticleCard from '../components/ui/ArticleCard.astro';
import SearchInput from '../components/ui/SearchInput.astro';
import { SITE_TITLE, CATEGORIES } from '../consts';
import { supabase } from '../lib/supabase';

const query = Astro.url.searchParams.get('q')?.trim() || '';

let articles: any[] = [];

if (query.length >= 2) {
	// Search in title and description using ilike (case-insensitive)
	const { data } = await supabase
		.from('article_titles')
		.select(`
			*,
			articles (generated_at)
		`)
		.eq('is_generated', true)
		.or(`title.ilike.%${query}%,description.ilike.%${query}%`)
		.order('created_at', { ascending: false })
		.limit(50);

	articles = data || [];
}
---

<!doctype html>
<html lang="de">
	<head>
		<BaseHead
			title={query ? `Suche: ${query} | ${SITE_TITLE}` : `Suche | ${SITE_TITLE}`}
			description="Durchsuchen Sie alle Artikel des Jagdblogs"
		/>
	</head>
	<body class="bg-[#faf8f3] text-gray-800">
		<Header />

		<!-- Search Header -->
		<section class="bg-gradient-to-br from-[#2d3e28] to-[#4a6741] py-12">
			<div class="max-w-3xl mx-auto px-4">
				<h1 class="text-3xl md:text-4xl font-bold text-white mb-6 text-center">
					Artikel durchsuchen
				</h1>
				<SearchInput value={query} placeholder="Nach Artikeln suchen..." size="md" class="max-w-xl mx-auto" />
			</div>
		</section>

		<main class="max-w-6xl mx-auto px-4 py-12">
			{query ? (
				<>
					{/* Search Results */}
					<div class="mb-8">
						<p class="text-gray-600">
							{articles.length === 0 ? (
								`Keine Ergebnisse für "${query}"`
							) : articles.length === 1 ? (
								`1 Ergebnis für "${query}"`
							) : (
								`${articles.length} Ergebnisse für "${query}"`
							)}
						</p>
					</div>

					{articles.length > 0 ? (
						<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
							{articles.map((article) => (
								<ArticleCard
									id={article.id}
									title={article.title}
									description={article.description}
									category={article.category}
									imageUrl={article.image_url}
									date={article.articles?.[0]?.generated_at || article.created_at}
								/>
							))}
						</div>
					) : (
						<div class="text-center py-16">
							<div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
								<svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
								</svg>
							</div>
							<h2 class="text-xl font-bold text-gray-800 mb-2">Keine Treffer</h2>
							<p class="text-gray-600 mb-6 max-w-md mx-auto">
								Versuchen Sie es mit anderen Suchbegriffen oder stöbern Sie in unseren Kategorien.
							</p>
							<a
								href="/kategorien"
								class="inline-flex items-center gap-2 px-5 py-2.5 bg-[#2d3e28] text-white font-medium rounded-xl hover:bg-[#4a6741] transition-colors"
							>
								Kategorien durchstöbern
							</a>
						</div>
					)}
				</>
			) : (
				/* No Search Query - Show Categories */
				<div class="text-center py-8">
					<div class="w-20 h-20 bg-[#2d3e28]/10 rounded-full flex items-center justify-center mx-auto mb-6">
						<svg class="w-10 h-10 text-[#2d3e28]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
						</svg>
					</div>
					<h2 class="text-xl font-bold text-[#2d3e28] mb-2">
						Wonach suchen Sie?
					</h2>
					<p class="text-gray-600 mb-8 max-w-md mx-auto">
						Geben Sie einen Suchbegriff ein oder stöbern Sie in unseren Kategorien.
					</p>

					<div class="border-t border-gray-200 pt-8">
						<h3 class="text-lg font-semibold text-[#2d3e28] mb-6">Beliebte Kategorien</h3>
						<div class="flex flex-wrap justify-center gap-3">
							{CATEGORIES.map((cat) => (
								<a
									href={`/kategorien/${cat.id}`}
									class="px-4 py-2 bg-white border-2 border-gray-200 rounded-full text-sm font-medium text-[#2d3e28] hover:border-[#4a6741] hover:bg-[#4a6741]/5 transition-all"
								>
									{cat.name}
								</a>
							))}
						</div>
					</div>
				</div>
			)}
		</main>

		<Footer />
	</body>
</html>
